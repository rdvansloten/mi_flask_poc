<!DOCTYPE html>
<html>
<head>
    <title>Managed Identities</title>
</head>
<body>

<h1>Managed Identities</h1>

<form action="/" method="post" id="mainForm">
    <input type="hidden" name="id_count" id="id_count" value="1">
      <!-- Add this somewhere within your <form> tag -->
      <div id="preloadedIdentityContainer" style="display:none;">{{ managed_identities|tojson|safe }}</div>


    <div id="identityContainer">
        <div class="identityBlock" id="identityBlock_1">
            <label>Identity ID: </label><input type="text" name="id_1"><br>
            <input type="hidden" name="roles_count_1" class="roles_count" value="1">

            <div class="rolesContainer" id="rolesContainer_1">
                <div class="roleBlock" id="roleBlock_1_1">
                    <label>Scope: </label><input type="text" name="scope_1_1">
                    <label>Role Definition: </label><input type="text" name="role_definition_1_1">
                    <label>Description: </label><input type="text" name="description_1_1">
                </div>
            </div>

            <button type="button" onclick="addRole(1)">Add Role</button>
        </div>
    </div>

    <button type="button" onclick="addIdentity()">Add Identity</button>
    <button type="submit">Submit</button>
</form>

<script>
let identityCount = 1;
let rolesCounts = { 1: 1 };

function addIdentity() {
    identityCount++;
    const identityContainer = document.getElementById("identityContainer");
    const newIdentity = document.createElement("div");
    newIdentity.className = "identityBlock";
    newIdentity.id = `identityBlock_${identityCount}`;
    newIdentity.innerHTML = `
        <label>Identity ID: </label><input type="text" name="id_${identityCount}"><br>
        <input type="hidden" name="roles_count_${identityCount}" class="roles_count" value="1">
        <div class="rolesContainer" id="rolesContainer_${identityCount}">
            <div class="roleBlock" id="roleBlock_${identityCount}_1">
                <label>Scope: </label><input type="text" name="scope_${identityCount}_1">
                <label>Role Definition: </label><input type="text" name="role_definition_${identityCount}_1">
                <label>Description: </label><input type="text" name="description_${identityCount}_1">
            </div>
        </div>
        <button type="button" onclick="addRole(${identityCount})">Add Role</button>
    `;
    identityContainer.appendChild(newIdentity);
    document.getElementById("id_count").value = identityCount;
}

function addRole(identityIndex) {
    if (!rolesCounts[identityIndex]) rolesCounts[identityIndex] = 1;
    rolesCounts[identityIndex]++;

    const roleContainer = document.getElementById(`rolesContainer_${identityIndex}`);
    const newRole = document.createElement("div");
    newRole.className = "roleBlock";
    newRole.id = `roleBlock_${identityIndex}_${rolesCounts[identityIndex]}`;
    newRole.innerHTML = `
        <label>Scope: </label><input type="text" name="scope_${identityIndex}_${rolesCounts[identityIndex]}">
        <label>Role Definition: </label><input type="text" name="role_definition_${identityIndex}_${rolesCounts[identityIndex]}">
        <label>Description: </label><input type="text" name="description_${identityIndex}_${rolesCounts[identityIndex]}">
    `;
    roleContainer.appendChild(newRole);
    document.querySelector(`input[name="roles_count_${identityIndex}"]`).value = rolesCounts[identityIndex];
}

window.onload = function() {
    let managedIdentities = document.getElementById('preloadedIdentityContainer').textContent;
    if (managedIdentities) {
        managedIdentities = JSON.parse(managedIdentities);
        
        // Reset the identity count
        identityCount = 0;
        
        for (let i = 0; i < managedIdentities.length; i++) {
            addIdentity();
            const identity = managedIdentities[i];
            document.getElementsByName(`id_${identityCount}`)[0].value = identity.id;

            // Reset the roles count for this identity
            rolesCounts[identityCount] = 0;

            for (let j = 0; j < identity.roles.length; j++) {
                addRole(identityCount);
                const role = identity.roles[j];
                document.getElementsByName(`scope_${identityCount}_${rolesCounts[identityCount]}`)[0].value = role.scope;
                document.getElementsByName(`role_definition_${identityCount}_${rolesCounts[identityCount]}`)[0].value = role.role_definition_name;
                document.getElementsByName(`description_${identityCount}_${rolesCounts[identityCount]}`)[0].value = role.description;
            }
        }
    }
};

  </script>

</body>
</html>
