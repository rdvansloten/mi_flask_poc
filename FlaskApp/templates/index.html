<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Managed Identities</title>
    <script>
        let identityCount = {{ managed_identities|length }};
        let roleCounts = {};

        {% for identity in managed_identities %}
            roleCounts[{{ loop.index }}] = {{ identity.roles|length }};
        {% endfor %}

        function addIdentity() {
            identityCount++;
            let idForm = document.getElementById("identityForms");

            let newIdentityDiv = document.createElement('div');
            newIdentityDiv.id = `identity_${identityCount}`;
            newIdentityDiv.innerHTML = `
                <label>ID:</label>
                <input type="text" name="id_${identityCount}">
                <button type="button" onclick="addRole(${identityCount})">Add Role</button>
                <div id="roles_${identityCount}"></div>
                <input type="hidden" id="roles_count_${identityCount}" name="roles_count_${identityCount}" value="0">
            `;
            idForm.appendChild(newIdentityDiv);
            roleCounts[identityCount] = 0;
        }

        function addRole(identityIndex) {
            let rolesDiv = document.getElementById(`roles_${identityIndex}`);
            roleCounts[identityIndex]++;

            let newRoleDiv = document.createElement('div');
            newRoleDiv.id = `role_${identityIndex}_${roleCounts[identityIndex]}`;
            newRoleDiv.innerHTML = `
                <label>Scope:</label>
                <input type="text" name="scope_${identityIndex}_${roleCounts[identityIndex]}">
                <label>Role:</label>
                <input type="text" name="role_definition_${identityIndex}_${roleCounts[identityIndex]}">
                <label>Description:</label>
                <input type="text" name="description_${identityIndex}_${roleCounts[identityIndex]}">
                <button type="button" onclick="deleteRole(${identityIndex}, ${roleCounts[identityIndex]})">Delete</button>
            `;
            rolesDiv.appendChild(newRoleDiv);
            document.getElementById(`roles_count_${identityIndex}`).value = roleCounts[identityIndex];
        }

        function deleteRole(identityIndex, roleIndex) {
            let roleDiv = document.getElementById(`role_${identityIndex}_${roleIndex}`);
            roleDiv.remove();
            roleCounts[identityIndex]--;
            document.getElementById(`roles_count_${identityIndex}`).value = roleCounts[identityIndex];
        }
    </script>
</head>
<body>

    <form action="/" method="post">
        <div id="identityForms">
            {% for identity in managed_identities %}
                <div id="identity_{{ loop.index }}">
                    <label>ID:</label>
                    <input type="text" name="id_{{ loop.index }}" value="{{ identity.id }}">
                    <button type="button" onclick="addRole({{ loop.index }})">Add Role</button>
                    <div id="roles_{{ loop.index }}">
                        {% for role in identity.roles %}
                            <div id="role_{{ loop.index }}">
                                <label>Scope:</label>
                                <input type="text" name="scope_{{ loop.index }}" value="{{ role.scope }}">
                                <label>Role:</label>
                                <input type="text" name="role_definition_{{ loop.index }}" value="{{ role.role_definition_name }}">
                                <label>Description:</label>
                                <input type="text" name="description_{{ loop.index }}" value="{{ role.description }}">
                                <button type="button" onclick="deleteRole({{ loop.index }})">Delete</button>
                            </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="roles_count_{{ loop.index }}" name="roles_count_{{ loop.index }}" value="{{ identity.roles|length }}">
                </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addIdentity()">Add Identity</button>
        <input type="hidden" id="id_count" name="id_count" value="{{ managed_identities|length }}">
        <input type="submit" value="Save">
    </form>

</body>
</html>
