<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Managed Identities</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .identity-block, .role-block {
      border: 2px solid #008ad7;
      margin-bottom: 15px;
      padding: 15px;
    }
    .identity-block label, .role-block label {
      font-weight: bold;
      margin-right: 10px;
    }
    .identity-block input, .identity-block select, .role-block input, .role-block select {
      margin: 5px;
    }
    button {
      background-color: #008ad7;
      color: white;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #006fa1;
    }
    input[type="submit"] {
      background-color: #008ad7;
      padding: 10px 20px;
      border: none;
      color: white;
      cursor: pointer;
    }
    input[type="submit"]:hover {
      background-color: #006fa1;
    }
  </style>
</head>
<body>
  <h1 style="color: #008ad7; text-align: center;">Managed Identities</h1>
  <form id="managed-identities-form">
    <div id="identities-container">
      <!-- Dynamic Identity Blocks will be appended here -->
    </div>
    <button type="button" id="add-identity">Add Identity</button>
    <input type="submit" value="Submit">
  </form>

  <script>
    $(document).ready(function() {
      // Function to add a new identity block
      function addIdentityBlock(identity = null) {
        const identityIndex = $(".identity-block").length + 1;
        let identityBlockHtml = `
          <div class="identity-block">
            <label for="id_${identityIndex}">Identity ID:</label>
            <input type="text" id="id_${identityIndex}" name="id_${identityIndex}">
            
            <label for="namespace_${identityIndex}">Namespace:</label>
            <input type="text" id="namespace_${identityIndex}" name="namespace_${identityIndex}">
            
            <label for="service_account_${identityIndex}">Service Account:</label>
            <input type="text" id="service_account_${identityIndex}" name="service_account_${identityIndex}">
            
            <label for="oidc_issuer_url_${identityIndex}">AKS Cluster:</label>
            <select id="oidc_issuer_url_${identityIndex}" name="oidc_issuer_url_${identityIndex}">
              <option value=""></option>
              <option value="https://westeurope.oic.prod-aks.azure.com/a1218954-d03b-40f0-a1d7-173a4944b29e/0a128b1c-c7d5-4228-b64b-969835f12146/">AKS Cluster "mi_test_aks"</option>
            </select>

            <label for="workload_identity_${identityIndex}">Workload Identity:</label>
            <select id="workload_identity_${identityIndex}" name="workload_identity_${identityIndex}">
              <option value="false">False</option>
              <option value="true">True</option>
            </select>

            <button type="button" class="remove-identity">Remove Identity</button>
            
            <div class="roles-container">
              <!-- Dynamic Role Blocks will be appended here -->
            </div>
            <button type="button" class="add-role">Add Role</button>
          </div>
        `;

        // If an identity argument is passed, populate the ID field
        if (identity) {
          identityBlockHtml = identityBlockHtml.replace(`name="id_${identityIndex}"`, `name="id_${identityIndex}" value="${identity.id}"`);
        }

        $('#identities-container').append(identityBlockHtml);
      }

      // Function to add a new role block
      function addRoleBlock(roleContainer, role = null, identityIndex, roleIndex) {
        const scopeValue = role ? `value="${role.scope}"` : '';
        const roleDefinitionValue = role ? `value="${role.role_definition}"` : '';
        const descriptionValue = role ? `value="${role.description}"` : '';
        
        const roleBlockHtml = `
          <div class="role-block">
            <label for="scope_${identityIndex}_${roleIndex}">Scope:</label>
            <select id="scope_${identityIndex}_${roleIndex}" name="scope_${identityIndex}_${roleIndex}" ${scopeValue}>
              <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad/resourceGroups/test-managed-identities">Resource Group "test-managed-identities"</option>
              <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad/resourceGroups/test-managed-identities/providers/Microsoft.KeyVault/vaults/testmgdidentitykv">Key Vault "testmgdidentitykv"</option>
              <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad/resourceGroups/test-managed-identities/providers/Microsoft.Storage/storageAccounts/testmgdidentities">Storage Account "testmgdidentities"</option>
              <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad/resourceGroups/test-managed-identities/providers/Microsoft.Network/virtualNetworks/testmgdidentities-vnet">Virtual Network "testmgdidentities-vnet"</option>
            </select>
            <label for="role_definition_${identityIndex}_${roleIndex}">Role Definition:</label>
            <select id="role_definition_${identityIndex}_${roleIndex}" name="role_definition_${identityIndex}_${roleIndex}" ${roleDefinitionValue}>
              <option value="Reader">Reader</option>
              <option value="Storage Account Contributor">Storage Account Contributor</option>
              <option value="Key Vault Administrator">Key Vault Administrator</option>
              <option value="Network Contributor">Network Contributor</option>
            </select>
            <label for="description_${identityIndex}_${roleIndex}">Description:</label>
            <input type="text" id="description_${identityIndex}_${roleIndex}" name="description_${identityIndex}_${roleIndex}" ${descriptionValue}>
            <button type="button" class="remove-role">Remove Role</button>
          </div>
        `;
        
        roleContainer.append(roleBlockHtml);
        const newlyAddedRoleBlock = roleContainer.children('.role-block').last();

        if (role) {
          newlyAddedRoleBlock.find(`select[name='scope_${identityIndex}_${roleIndex}'] option`).each(function() {
            if ($(this).val() === role.scope) {
              $(this).prop('selected', true);
            }
          });
          newlyAddedRoleBlock.find(`select[name='role_definition_${identityIndex}_${roleIndex}'] option`).each(function() {
            if ($(this).val() === role.role_definition) {
              $(this).prop('selected', true);
            }
          });
        }
      }

      // Fetch managed identities from the server
      $.getJSON("/get_managed_identities", function(data) {
        data.forEach(function(identity, identityIndex) {
          addIdentityBlock(identity);

          const roleContainer = $('.identity-block:last .roles-container');
          identity.roles.forEach(function(role, roleIndex) {
            addRoleBlock(roleContainer, role, identityIndex + 1);
          });
        });
      });

      // Add a new identity block on click
      $('#add-identity').click(function() {
        addIdentityBlock();
      });

      // Add a new role block to the identity block on click
      $('#identities-container').on('click', '.add-role', function() {
        const roleContainer = $(this).prev('.roles-container');
        addRoleBlock(roleContainer);
      });

      // Remove an identity block on click
      $('#identities-container').on('click', '.remove-identity', function() {
        $(this).parent('.identity-block').remove();
      });

      // Remove a role block on click
      $('#identities-container').on('click', '.remove-role', function() {
        $(this).parent('.role-block').remove();
      });

      // Form Submission
      $("#managed-identities-form").on("submit", function(e) {
        e.preventDefault();

        let identities = [];
        $(".identity-block").each(function() {
          let identityId = $(this).find("input[name^='id']").val();

          // Get the new fields' values
          let namespace = $(this).find("input[name^='namespace']").val();
          let service_account = $(this).find("input[name^='service_account']").val();
          let oidc_issuer_url = $(this).find("input[name^='oidc_issuer_url']").val();
          let workload_identity = $(this).find("select[name^='workload_identity']").val() === "true" ? true : false;

          let roles = [];
          $(this).find(".role-block").each(function() {
            let scope = $(this).find("select[name^='scope']").val();
            let role_definition = $(this).find("select[name^='role_definition']").val();
            let description = $(this).find("input[name^='description']").val();
            roles.push({ scope, role_definition, description });
          });
          
          identities.push({ 
            id: identityId, 
            namespace,
            service_account,
            oidc_issuer_url,
            workload_identity,
            roles 
          });
        });

        // Send the data as JSON
        $.ajax({
          url: '/',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({identities}),
          dataType: 'json',
          success: function(data) {
            // Handle success
            console.log("Successfully submitted the form");
            window.location.reload();  // or any other action
          },
          error: function(xhr, status, error) {
            // Handle error
            console.log("Error:", error);
          }
        });
      });
    });
  </script>
</body>
</html>
