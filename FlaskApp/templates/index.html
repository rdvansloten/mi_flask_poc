<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Managed Identities</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .identity-block, .role-block {
      border: 2px solid #008ad7;
      margin-bottom: 15px;
      padding: 15px;
    }
    .identity-block label, .role-block label {
      font-weight: bold;
      margin-right: 10px;
    }
    .identity-block input, .identity-block select, .role-block input, .role-block select {
      margin: 5px;
    }
    button {
      background-color: #008ad7;
      color: white;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #006fa1;
    }
    input[type="submit"] {
      background-color: #008ad7;
      padding: 10px 20px;
      border: none;
      color: white;
      cursor: pointer;
    }
    input[type="submit"]:hover {
      background-color: #006fa1;
    }
  </style>
</head>
<body>
  <h1 style="color: #008ad7; text-align: center;">Managed Identities</h1>
  <form id="managed-identities-form">
    <div id="identities-container">
      <!-- Dynamic Identity Blocks will be appended here -->
    </div>
    <button type="button" id="add-identity">Add Identity</button>
    <input type="submit" value="Submit">
  </form>

  <script>
    $(document).ready(function() {
      // Function to add a new identity block
      function addIdentityBlock() {
        const identityIndex = $(".identity-block").length + 1;
        const identityBlockHtml = `
          <div class="identity-block">
            <label for="id_${identityIndex}">Identity ID:</label>
            <input type="text" id="id_${identityIndex}" name="id_${identityIndex}">
            <button type="button" class="remove-identity">Remove Identity</button>
            <div class="roles-container">
              <!-- Dynamic Role Blocks will be appended here -->
            </div>
            <button type="button" class="add-role">Add Role</button>
          </div>
        `;
        
        // Populate the identity ID if it exists
        if (identity && identity.id) {
          identityBlockHtml = identityBlockHtml.replace('name="id"', `name="id" value="${identity.id}"`);
        }

        $('#identities-container').append(identityBlockHtml);
      }

      // Function to add a new role block
      function addRoleBlock(roleContainer, role, identityIndex) {
        const roleIndex = roleContainer.children('.role-block').length + 1;
        const roleBlockHtml = `
          <div class="role-block">
            <label for="scope_${roleIndex}">Scope:</label>
            <select id="scope_${roleIndex}" name="scope_${roleIndex}">
              <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad">Subscription "Personal"</option>
              <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad/resourceGroups/mi_flask_poc">Resource Group "mi_flask_poc"</option>
            </select>
            <label for="role_definition_${roleIndex}">Role Name:</label>
            <select id="role_definition_${roleIndex}" name="role_definition_${roleIndex}">
              <option value="Reader">Reader</option>
              <option value="Contributor">Contributor</option>
              <option value="Owner">Owner</option>
            </select>
            <label for="description_${roleIndex}">Description:</label>
            <input type="text" id="description_${roleIndex}" name="description_${roleIndex}">
            <button type="button" class="remove-role">Remove Role</button>
          </div>
        `;
        
        // Populate the role fields if they exist
        if (role) {
          roleBlockHtml = roleBlockHtml.replace('name="scope"', `name="scope_${identityIndex}_${roleIndex}" value="${role.scope}"`);
          roleBlockHtml = roleBlockHtml.replace('name="role_definition"', `name="role_definition_${identityIndex}_${roleIndex}" value="${role.role_definition}"`);
          roleBlockHtml = roleBlockHtml.replace('name="description"', `name="description_${identityIndex}_${roleIndex}" value="${role.description}"`);
        }

        roleContainer.append(roleBlockHtml);
      }

      // Fetch managed identities from the server
      $.getJSON("/get_managed_identities", function(data) {
      data.forEach(function(identity, identityIndex) {
        addIdentityBlock(identity);

        const roleContainer = $('.identity-block:last .roles-container');
        identity.roles.forEach(function(role, roleIndex) {
          addRoleBlock(roleContainer, role, identityIndex + 1);
        });
      });
    });

      // Add a new identity block on click
      $('#add-identity').click(function() {
        addIdentityBlock();
      });

      // Add a new role block to the identity block on click
      $('#identities-container').on('click', '.add-role', function() {
        const roleContainer = $(this).prev('.roles-container');
        addRoleBlock(roleContainer);
      });

      // Remove an identity block on click
      $('#identities-container').on('click', '.remove-identity', function() {
        $(this).parent('.identity-block').remove();
      });

      // Remove a role block on click
      $('#identities-container').on('click', '.remove-role', function() {
        $(this).parent('.role-block').remove();
      });

      // Form Submission
      $("#managed-identities-form").on("submit", function(e) {
        e.preventDefault();

        let identities = [];
        $(".identity-block").each(function() {
          let identityId = $(this).find("input[name^='id']").val();
          let roles = [];
          $(this).find(".role-block").each(function() {
            let scope = $(this).find("select[name^='scope']").val();
            let role_definition = $(this).find("select[name^='role_definition']").val();
            let description = $(this).find("input[name^='description']").val();
            roles.push({ scope, role_definition, description });
          });
          identities.push({ id: identityId, roles });
        });

        // Send the data as JSON
        $.ajax({
          url: '/',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({identities}),
          dataType: 'json',
          success: function(data) {
            // Handle success
            console.log("Successfully submitted the form");
            window.location.reload();  // or any other action
          },
          error: function(xhr, status, error) {
            // Handle error
            console.log("Error:", error);
          }
        });
      });
    });
  </script>
</body>
</html>
