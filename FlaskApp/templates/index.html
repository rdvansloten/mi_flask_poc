<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Managed Identities</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <form id="managed-identities-form" action="/" method="post">
    <div id="identities-container">
      {% for identity in managed_identities %}
      <div class="identity-block">
        <label for="id_{{ loop.index }}">Identity ID:</label>
        <input type="text" id="id_{{ loop.index }}" name="id_{{ loop.index }}" value="{{ identity.id }}">
        <button type="button" class="remove-identity">Remove Identity</button>
        <div class="roles-container">
          {% for role in identity.roles %}
          <div class="role-block">
            <label for="scope_{{ loop.index }}">Scope:</label>
            <select id="scope_{{ loop.index }}" name="scope_{{ loop.index }}">
              <option value="scope1" {% if role.scope == "scope1" %}selected{% endif %}>Scope 1</option>
              <option value="scope2" {% if role.scope == "scope2" %}selected{% endif %}>Scope 2</option>
            </select>

            <label for="role_definition_{{ loop.index }}">Role Definition:</label>
            <select id="role_definition_{{ loop.index }}" name="role_definition_{{ loop.index }}">
              <option value="role1" {% if role.role_definition_name == "role1" %}selected{% endif %}>Role 1</option>
              <option value="role2" {% if role.role_definition_name == "role2" %}selected{% endif %}>Role 2</option>
            </select>

            <label for="description_{{ loop.index }}">Description:</label>
            <input type="text" id="description_{{ loop.index }}" name="description_{{ loop.index }}" value="{{ role.description }}">
            <button type="button" class="remove-role">Remove Role</button>
          </div>
          {% endfor %}
        </div>
        <button type="button" class="add-role">Add Role</button>
      </div>
      {% endfor %}
    </div>
    <button type="button" id="add-identity">Add Identity</button>
    <input type="submit" value="Submit">
  </form>

  <script>
    $(document).ready(function() {
      // Function to add a new identity block
      function addIdentityBlock(identityIndex, identityData) {
        const identityBlockHtml = `
        <div class="identity-block" data-identity-index="${identityIndex}">
            <label for="id_${identityIndex}">Identity ID:</label>
            <input type="text" id="id_${identityIndex}" name="id_${identityIndex}" value="${identityData ? identityData.id : ''}">
            <button type="button" class="remove-identity">Remove Identity</button>
            <div class="roles-container">
            </div>
            <button type="button" class="add-role">Add Role</button>
          </div>
        `;
        $('#identities-container').append(identityBlockHtml);
      }

      // Function to add a new role block
      function addRoleBlock(roleContainer, roleIndex, identityIndex, roleData) {
        const roleBlockHtml = `
          <div class="role-block" data-role-index="${roleIndex}" data-identity-index="${identityIndex}">
            <label for="scope_${roleIndex}">Scope:</label>
            <select id="scope_${roleIndex}" name="scope_${roleIndex}">
              <option value="scope1" ${roleData && roleData.scope == 'scope1' ? 'selected' : ''}>Scope 1</option>
              <option value="scope2" ${roleData && roleData.scope == 'scope2' ? 'selected' : ''}>Scope 2</option>
            </select>

            <label for="role_definition_${roleIndex}">Role Definition:</label>
            <select id="role_definition_${roleIndex}" name="role_definition_${roleIndex}">
              <option value="role1" ${roleData && roleData.role_definition_name == 'role1' ? 'selected' : ''}>Role 1</option>
              <option value="role2" ${roleData && roleData.role_definition_name == 'role2' ? 'selected' : ''}>Role 2</option>
            </select>

            <label for="description_${roleIndex}">Description:</label>
            <input type="text" id="description_${roleIndex}" name="description_${roleIndex}" value="${roleData ? roleData.description : ''}">
            <button type="button" class="remove-role">Remove Role</button>
          </div>
        `;
        roleContainer.append(roleBlockHtml);
      }

      // Add a new role block to the identity block on click
      $('#identities-container').on('click', '.add-role', function() {
        const roleContainer = $(this).prev('.roles-container');
        const roleIndex = roleContainer.children('.role-block').length + 1;
        const identityBlock = $(this).closest('.identity-block');
        const identityIndex = identityBlock.data('identity-index');
        addRoleBlock(roleContainer, roleIndex, identityIndex, null);
      });

      // Add a new identity block on click
      $('#add-identity').click(function() {
        const identityIndex = $('.identity-block').length + 1;
        addIdentityBlock(identityIndex, null);
      });

      // Add a new role block to the identity block on click
      $('#identities-container').on('click', '.add-role', function() {
        const roleContainer = $(this).prev('.roles-container');
        const roleIndex = roleContainer.children('.role-block').length + 1;
        addRoleBlock(roleContainer, roleIndex, null);
      });

      // Remove an identity block on click
      $('#identities-container').on('click', '.remove-identity', function() {
        $(this).parent('.identity-block').remove();
      });

      // Remove a role block on click
      $('#identities-container').on('click', '.remove-role', function() {
        $(this).parent('.role-block').remove();
      });
    });
  </script>
</body>
</html>
