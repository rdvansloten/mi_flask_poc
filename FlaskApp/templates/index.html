<!DOCTYPE html>
<html>

<head>
    <title>Managed Identities</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        h1 {
            background-color: #008AD7;
            color: white;
            padding: 1em;
            margin: 0;
        }
        
        form {
            padding: 2em;
        }
        
        .identity {
            border: 1px solid #ccc;
            margin-bottom: 2em;
            padding: 1em;
            border-radius: 5px;
        }
        
        .role {
            border: 1px dashed #ccc;
            margin: 1em;
            padding: 1em;
        }
        
        button,
        input[type="submit"] {
            background-color: #008AD7;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }
        
        button:hover,
        input[type="submit"]:hover {
            background-color: #008AD7;
        }
    </style>
</head>

<body>
  <h1>Managed Identities</h1>
  <form action="/" method="post">
    <input type="hidden" id="id_count" name="id_count" value="{{ managed_identities|length }}">
    <div id="identities">
        {% for identity in managed_identities %}
        <div class="identity" id="identity_{{ loop.index }}">
            <label>Managed Identity: <input type="text" name="id_{{ loop.index }}" value="{{ identity.id }}"></label>
            <input type="hidden" id="roles_count_{{ loop.index }}" name="roles_count_{{ loop.index }}" value="{{ identity.roles|length }}">
            <button type="button" onclick="deleteIdentity({{ loop.index }})">Delete Identity</button>
            <div id="roles_{{ loop.index }}">
                {% for role in identity.roles %}
                <div class="role" id="role_{{ loop.index }}">
                  <label>Scope:</label>
                  <select name="scope_{{ loop.index }}">
                      <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad" {% if role.scope == '/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad' %}selected{% endif %}>Subscription "Personal"</option>
                      <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad/resourceGroups/mi_flask_poc" {% if role.scope == '/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad/resourceGroups/mi_flask_poc' %}selected{% endif %}>Resource Group "mi_flask_poc"</option>
                  </select>
                  <label>Role Definition:</label>
                  <select name="role_definition_{{ loop.index }}">
                      <option value="Contributor" {% if role.role_definition_name == 'Contributor' %}selected{% endif %}>Contributor</option>
                      <option value="Reader" {% if role.role_definition_name == 'Reader' %}selected{% endif %}>Reader</option>
                  </select>
                  <label>Description:</label>
                  <input type="text" name="description_{{ loop.index }}" value="{{ role.description }}">
                  <button type="button" onclick="deleteRole({{ loop.index }})">Delete Role</button>
                </div>
              {% endfor %}
            </div>
            <button type="button" onclick="addRole({{ loop.index }})">Add Another Role</button>
        </div>
        {% endfor %}
    </div>
    <button type="button" onclick="addIdentity()">Add Another Identity</button>
    <input type="submit" value="Submit">
  </form>
    <script>
        let identityCount = 1;
        let roleCounts = { 1: 1 };

        function addIdentity() {
            identityCount++;
            const identityDiv = document.createElement('div');
            identityDiv.className = "identity";
            identityDiv.id = `identity_${identityCount}`;
            identityDiv.innerHTML = `
                <label>Managed Identity: <input type="text" name="id_${identityCount}"></label>
                <input type="hidden" id="roles_count_${identityCount}" name="roles_count_${identityCount}" value="1">
                <div id="roles_${identityCount}">
                    <div class="role" id="role_${identityCount}_1">
                        <label>Scope:</label>
                        <select name="scope_${identityCount}_1">
                            <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad">Subscription "Personal"</option>
                            <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad/resourceGroups/mi_flask_poc">Resource Group "mi_flask_poc"</option>
                        </select>
                        <label>Role Definition:</label>
                        <select name="role_definition_${identityCount}_1">
                            <option value="Contributor">Contributor</option>
                            <option value="Reader">Reader</option>
                        </select>
                        <label>Description:</label>
                        <input type="text" name="description_${identityCount}_1">
                    </div>
                </div>
                <button type="button" onclick="addRole(${identityCount})">Add Another Role</button>
            `;
            document.getElementById('identities').appendChild(identityDiv);
            document.getElementById('id_count').value = identityCount;
            roleCounts[identityCount] = 1;
        }

        function addRole(identityId) {
            roleCounts[identityId]++;
            const roleDiv = document.createElement('div');
            roleDiv.className = "role";
            roleDiv.id = `role_${identityId}_${roleCounts[identityId]}`;
            roleDiv.innerHTML = `
                <label>Scope:</label>
                <select name="scope_${identityId}_${roleCounts[identityId]}">
                  <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad">Subscription "Personal"</option>
                  <option value="/subscriptions/865f86e6-0a9a-4c2f-8742-ce207e509dad/resourceGroups/mi_flask_poc">Resource Group "mi_flask_poc"</option>
                </select>
                <label>Role Definition:</label>
                <select name="role_definition_${identityId}_${roleCounts[identityId]}">
                    <option value="Contributor">Contributor</option>
                    <option value="Reader">Reader</option>
                </select>
                <label>Description:</label>
                <input type="text" name="description_${identityId}_${roleCounts[identityId]}">
            `;
            document.getElementById(`roles_${identityId}`).appendChild(roleDiv);
            document.getElementById(`roles_count_${identityId}`).value = roleCounts[identityId];
        }

        function deleteIdentity(identityId) {
            const identityDiv = document.getElementById(`identity_${identityId}`);
            identityDiv.remove();
            identityCount--;
            document.getElementById('id_count').value = identityCount;
        }

        function deleteRole(roleId) {
            const roleDiv = document.getElementById(`role_${roleId}`);
            roleDiv.remove();
            // Update roleCounts and roles_count hidden input
        }
    </script>
</body>

</html>
